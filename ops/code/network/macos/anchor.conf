# UICP pf anchor (macOS)
# - UI: allow general web on TCP 80/443 and UDP 443
# - Jobs: default deny; allow only to <allow_job> on 80/443; QUIC blocked
# - Global guards: DNS only to <allow_dns>, block DoT 853, block DoH IPs on 443,
#                  block cloud metadata, block private/link-local from jobs

# Tables populated by updater/ops scripts
# Use pfctl -a com.uicp.fw -t <table> -T replace -f <file> to update dynamically

table <allow_dns> persist

table <allow_job> persist

table <block_doh> persist

table <block_meta_v4> persist

table <block_meta_v6> persist

table <block_priv_v4> persist

table <block_priv_v6> persist

set skip on lo0

# Common blocks
# DNS restricted to known resolvers
pass out quick proto { udp tcp } to <allow_dns> port 53 keep state
# Block DoT/DoQ and DoH IPs
block out quick proto tcp to port 853
block out quick proto udp to port 853
block out quick proto tcp to {443} to <block_doh>
block out quick proto udp to {443} to <block_doh>
# Cloud metadata
block out quick to <block_meta_v4>
block out quick to <block_meta_v6>

# UI (group uicpui): allow HTTP/HTTPS + QUIC
pass out quick proto tcp to port {80,443} user _wildcard group uicpui keep state
pass out quick proto udp to port 443 user _wildcard group uicpui keep state

# JOBS (group uicpjob): default block, then narrow allows
# Block private/link-local egress for jobs
block out quick to <block_priv_v4> user _wildcard group uicpjob
block out quick to <block_priv_v6> user _wildcard group uicpjob
# Block QUIC for jobs by default
block out quick proto udp to port 443 user _wildcard group uicpjob
# Allow only seeded job hosts on 80/443
pass out quick proto tcp to <allow_job> port {80,443} user _wildcard group uicpjob keep state
# Default block for any other job egress
block out quick user _wildcard group uicpjob
